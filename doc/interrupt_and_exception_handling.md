# 中断和异常处理

## 异常分类
异常(Exception)分为三类
1. 错误(Fault), 可以被修正的异常, 处理器可以将运行环境还原至异常发生前, 重新执行发生异常的指令
2. 陷阱(Trap), 允许处理器继续执行程序或任务, 只不过会跳过发生异常的指令, 从发生异常指令之后的指令执行
3. 终止(Abort), 发生非常严重的错误, 程序不可恢复

## IA-32e中断/陷阱门描述符
```asm
; ---------------------------------------------------------------------------------------
; |127                                                                                96|
; |                                       保留                                          | 
; ---------------------------------------------------------------------------------------
; |96                                                                                 64|
; |                                   段内偏移(63:32)                                   |
; ---------------------------------------------------------------------------------------
; |63                                     48|47|46  45|44|43     40|39      35|34     32|
; |              段内偏移(31:16)            | P|  DPL |S |  Type   |    0     |   IST   |
; ---------------------------------------------------------------------------------------
; |31                                     17|16					       0|
; |                段选择子                 |              段内偏移(15:00)              |
; ---------------------------------------------------------------------------------------
; P 存在位/有效位
; DPL 特权级
; S=0 表示系统段
;	Type=0xF 陷阱门
;	Type=0xE 中断门
```

处理器捕获到中断/异常时, 根据中断/异常向量号(Interrupt Vector)从中断描述表(IDT)中, 获取到相应的门描述符, 再根据门描述符定位到处理程序的位置.

## TSS描述符
```asm
; ---------------------------------------------------------------------------------------
; |127                                                                                96|
; |                                       保留                                          | 
; ---------------------------------------------------------------------------------------
; |96                                                                                 64|
; |                                    段基(63:32)                                      |
; ---------------------------------------------------------------------------------------
; |63               56|55 53|52 |51       48|47|46  45|44|43     40|39                32|
; |      段基(31:24)  |  0  |AVL|段长(19:16)| P|  DPL |S |  Type   |     段基(23:16)    |
; ---------------------------------------------------------------------------------------
; |31                                     17|16					       0|
; |                段基(15:0)               |              段长(15:00)                  |
; ---------------------------------------------------------------------------------------
; P 存在位/有效位
; DPL 特权级
; S=0 表示系统段
;	Type=0x9 任务状态段(有效的)
;	Type=0xB 任务状态段(无效的) 
```
在head.S定义的任务状态表, 段长为13\*8-1=103, 段基为TSS_Table(%rip)
```ams
.globl TSS_Table

TSS_Table:
        .fill 13, 8, 0
TSS_END:

TSS_PTR:
TSS_LIMIT:      .word TSS_END - TSS_Table - 1
TSS_BASE:       .quad TSS_Table
```
任务状态段, 主要用于任务切换时, 保存任务状态. 

## 错误码
### 通用的错误码格式
```asm
; -----------------------------------------------------------------------------------
; |31                                  16|15                      3| 2  |  1  |  0  |
; |                Reserved              |  Segment Selector Index | TI | IDT | EXT |
; -----------------------------------------------------------------------------------
; EXT 置位, 说明异常是在向程序投递外部事件过程触发, 例如一个中断或一个更早期的异常. (不是很明白)
; IDT 置位, 段选择子代表IDT内的门描述符; 复位, 段选择子代表GDT/LDT内的描述符.
; TI  (IDT复位有效) 置位, 段选择子代表LDT; 复位, 段选择子代表GDT
```

### 页错误的错误码
```asm
; --------------------------------------------------------------------------
; |31                                       5 |  4  |   3  |  2  |  1  | 0 |
; |          Reserved                         | I/D | PSVD | U/S | W/R | P |
; --------------------------------------------------------------------------
; P	0 页不存在
;	1 页级保护

; W/R	0 读操作
;	1 写操作

; U/S	0 特权模式(supervisor-mode)
;	1 用户模式(user-mode)

; RSVD	0 保留位未引发异常
;	1 页表项置位保留位引发异常

; I/D	0 指令获取未引发异常
;	1 指令获取导致异常
```
